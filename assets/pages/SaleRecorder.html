<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Tracker</title>
  <!-- React CDN -->
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js">
  </script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.21.2/babel.min.js"></script>
  <!-- Pico CSS (light) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
  <style>
    .url-button {
      margin-left: 0.5rem;
      padding: 0.25rem 0.5rem;
      font-size: 0.8rem;
    }

    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .suggestion-container {
      position: relative;
    }

    .suggestion-list {
      position: absolute;
      z-index: 100;
      width: 100%;
      max-height: 150px;
      /* Show about 5 items with scroll */
      overflow-y: auto;
      background: var(--card-background-color);
      border: 1px solid var(--card-border-color);
      border-radius: 0 0 var(--border-radius) var(--border-radius);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      margin-top: -1px;
      /* Align with input border */
    }

    .actions-cell {
      white-space: nowrap;
    }

    .actions-cell button {
      display: inline-block !important;
      padding: 0 0.25rem !important;
      min-width: auto !important;
      width: auto !important;
      margin-right: 2px;
    }

    .actions-cell button:last-child {
      margin-right: 0;
    }

    .suggestion-item {
      cursor: pointer;
      padding: 0.5rem;
      border-bottom: 1px solid var(--card-border-color);
    }

    .suggestion-item:hover {
      background: var(--card-sectionning-background-color);
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    /* Custom styles */
    .container {
      padding: 1rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    .title {
      text-align: center;
      margin-bottom: 2rem;
    }

    .view-buttons {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      margin-top: 1rem;
    }

    .search-container {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      align-items: center;
    }

    .suggestion-item {
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      background: var(--card-background-color);
      border: 1px solid var(--card-border-color);
      margin-top: 0.25rem;
    }

    .suggestion-item:hover {
      background: var(--card-sectionning-background-color);
    }

    table {
      width: 100%;
      margin-top: 1rem;
    }

    th {
      cursor: pointer;
      white-space: nowrap;
    }

    .empty-state {
      text-align: center;
      padding: 2rem;
      color: var(--muted-color);
    }

    .actions-cell {
      white-space: nowrap;
    }

    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: var(--card-background-color);
      padding: 2rem;
      border-radius: var(--border-radius);
      max-width: 800px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      width: 3rem;
    }

    .stats-table {
      width: 100%;
      border-collapse: collapse;
    }

    .stats-table th,
    .stats-table td {
      padding: 0.5rem;
      text-align: left;
      border-bottom: 1px solid var(--card-border-color);
    }

    .stats-table th {
      background-color: var(--card-sectionning-background-color);
    }

    .stats-table tr:hover {
      background-color: var(--card-sectionning-background-color);
    }

    .clickable-name {
      cursor: pointer;
      color: var(--primary);
      text-decoration: underline;
    }

    .clickable-name:hover {
      color: var(--primary-hover);
    }

    .clickable-header {
      cursor: pointer;
    }

    .clickable-header:hover {
      text-decoration: underline;
    }

    .x-checkbox {
      appearance: none;
      width: 1.2em;
      height: 1.2em;
      border: 2px solid var(--form-element-border-color);
      border-radius: 2px;
      position: relative;
      cursor: pointer;
    }

    .x-checkbox:checked::before {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      width: 70%;
      height: 2px;
      background: var(--form-element-invalid-border-color);
      transform: translate(-50%, -50%) rotate(45deg);
    }

    .x-checkbox:checked::after {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      width: 70%;
      height: 2px;
      background: var(--form-element-invalid-border-color);
      transform: translate(-50%, -50%) rotate(-45deg);
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const App = () => {
      const [view, setView] = useState('input'); // 'input' or 'view'
      const [records, setRecords] = useState([]);
      const [editingId, setEditingId] = useState(null);
      const [searchTerm, setSearchTerm] = useState('');
      const [sortConfig, setSortConfig] = useState({ key: null, direction: 'asc' });
      const [showArchived, setShowArchived] = useState(false);
      const [modalData, setModalData] = useState(null);
      const [modalType, setModalType] = useState(null); // 'buyer' or 'product' or 'buyerFrequency'
      const [modalRecord, setModalRecord] = useState(null); // Track which record's URL to show

      const [formData, setFormData] = useState({
        id: Date.now(),
        buyerName: '',
        productName: '',
        link: '',
        agreedPrice: '',
        size: '',
        isPaymentMade: false,
        isProductPurchased: false,
        isProductShort: false,
        purchaseDate: '',
      });

      // Load data from localStorage on component mount
      useEffect(() => {
        const storedRecords = localStorage.getItem('productRecords');
        if (storedRecords) {
          setRecords(JSON.parse(storedRecords));
        }
      }, []);

      // Save data to localStorage whenever records change
      useEffect(() => {
        localStorage.setItem('productRecords', JSON.stringify(records));
      }, [records]);


      const XCheckbox = ({ label, id, checked: propChecked, onChange }) => {
        const [internalChecked, setInternalChecked] = useState(propChecked || false);

        // Use controlled component pattern if propChecked is provided
        const isControlled = typeof propChecked !== 'undefined';
        const checked = isControlled ? propChecked : internalChecked;

        const handleChange = (e) => {
          if (!isControlled) {
            setInternalChecked(e.target.checked);
          }
          onChange?.(e);
        };

        return (
          <div style={{ position: 'relative' }}>
            <input
              type="checkbox"
              id={id}
              checked={checked}
              onChange={handleChange}
              style={{
                appearance: 'none',
                width: '1.2em',
                height: '1.2em',
                border: '2px solid var(--form-element-border-color)',
                borderRadius: '2px',
                position: 'relative',
                cursor: 'pointer',
                verticalAlign: 'middle',
              }}
            />
            {checked && (
              <span
                style={{
                  position: 'absolute',
                  left: '0.2em',
                  top: '50%',
                  transform: 'translateY(-50%)',
                  color: 'var(--form-element-invalid-border-color)',
                  fontWeight: 'bold',
                  pointerEvents: 'none',
                }}
                aria-hidden="true"
              >
                X
              </span>
            )}
            {label && (
              <label htmlFor={id} style={{ marginLeft: '0.5em', cursor: 'pointer' }}>
                {label}
              </label>
            )}
          </div>
        );
      };


      const handleInputChange = (e) => {
        const { name, value, type, checked } = e.target;
        setFormData({
          ...formData,
          [name]: type === 'checkbox' ? checked : value
        });
      };
      const getProductFrequencyReport = () => {
        const productStats = {};

        // Calculate stats for each product
        records.forEach(record => {
          const product = record.productName;
          if (!product) return;

          if (!productStats[product]) {
            productStats[product] = {
              count: 0,
              totalAmount: 0,
              lastPurchaseDate: '',
              link: record.link || '',
              records: []
            };
          }

          productStats[product].count++;
          productStats[product].totalAmount += parseFloat(record.agreedPrice) || 0;

          // Keep track of the most recent purchase date
          if (!productStats[product].lastPurchaseDate ||
            record.purchaseDate > productStats[product].lastPurchaseDate) {
            productStats[product].lastPurchaseDate = record.purchaseDate;
            // Update link to the most recent purchase
            if (record.link) {
              productStats[product].link = record.link;
            }
          }

          productStats[product].records.push(record);
        });

        // Convert to array and sort by count (descending)
        return Object.entries(productStats)
          .map(([name, stats]) => ({ name, ...stats }))
          .sort((a, b) => b.count - a.count)
          .slice(0, 20); // Top 20 products
      };

      const showStatsModal = (type, name, record = null) => {
        setModalType(type);
        setModalRecord(record); // Store the record for URL purposes
        if (type === 'buyerFrequency') {
          setModalData(getBuyerFrequencyReport());
        } else if (type === 'productFrequency') {
          setModalData(getProductFrequencyReport());
        } else {
          setModalData(getStatsData(type, name));
        }
      };

      const handleProductHeaderClick = () => {
        requestSort('productName');
        showStatsModal('productFrequency');
      };


      const handleSubmit = (e) => {
        e.preventDefault();
        const currentDate = new Date().toISOString().split('T')[0];
        const updatedFormData = {
          ...formData,
          purchaseDate: formData.purchaseDate || currentDate
        };
        if (editingId !== null) {
          setRecords(records.map(record =>
            record.id === editingId ? { ...updatedFormData } : record
          ));
          setEditingId(null);
        } else {
          setRecords([...records, { ...updatedFormData, id: Date.now() }]);
        }
        setFormData({
          id: Date.now(),
          buyerName: '',
          productName: '',
          link: '',
          agreedPrice: '',
          size: '',
          isPaymentMade: false,
          isProductPurchased: false,
          isProductShort: false,
          purchaseDate: '',
        });
      };

      const handleEdit = (record) => {
        setFormData({ ...record });
        setEditingId(record.id);
        setView('input');
      };

      const handleDelete = (id) => {
        if (confirm('Are you sure you want to delete this record?')) {
          setRecords(records.filter(record => record.id !== id));
        }
      };

      const requestSort = (key) => {
        let direction = 'asc';
        if (sortConfig.key === key && sortConfig.direction === 'asc') {
          direction = 'desc';
        }
        setSortConfig({ key, direction });
      };

      const sortedRecords = () => {
        let sortableRecords = [...records];
        if (sortConfig.key) {
          sortableRecords.sort((a, b) => {
            if (a[sortConfig.key] < b[sortConfig.key]) {
              return sortConfig.direction === 'asc' ? -1 : 1;
            }
            if (a[sortConfig.key] > b[sortConfig.key]) {
              return sortConfig.direction === 'asc' ? 1 : -1;
            }
            return 0;
          });
        }
        return sortableRecords;
      };

      const filteredRecords = sortedRecords().filter(record => {
        return (
          record.buyerName.toLowerCase().includes(searchTerm.toLowerCase()) ||
          record.productName.toLowerCase().includes(searchTerm.toLowerCase())
        );
      });

      const displayedRecords = filteredRecords.filter(r => showArchived || !r.archived);

      const getSortIcon = (key) => {
        if (sortConfig.key !== key) return '⇅';
        return sortConfig.direction === 'asc' ? '↑' : '↓';
      };

      const getFrequencyMap = (key) => {
        const map = {};
        records.forEach(record => {
          const value = record[key];
          if (value) {
            map[value] = (map[value] || 0) + 1;
          }
        });
        return Object.entries(map)
          .sort((a, b) => b[1] - a[1]) // sort by frequency
          .map(([value]) => value)
          .slice(0, 20); // max 20 suggestions
      };

      const getStatsData = (type, name) => {
        const filteredRecords = records.filter(record =>
          type === 'buyer' ? record.buyerName === name : record.productName === name
        );

        // Calculate total amount spent
        const totalAmount = filteredRecords.reduce((sum, record) => {
          return sum + (parseFloat(record.agreedPrice) || 0);
        }, 0);

        // Calculate average price
        const avgPrice = filteredRecords.length > 0
          ? (totalAmount / filteredRecords.length).toFixed(0)
          : 0;

        const cheapPrice = filteredRecords.length
          ? Math.min(...filteredRecords
            .map(obj => parseFloat(obj.agreedPrice)))
          : "0";

        // Get most common size
        const sizeCounts = {};
        filteredRecords.forEach(record => {
          if (record.size) {
            sizeCounts[record.size] = (sizeCounts[record.size] || 0) + 1;
          }
        });
        const mostCommonSize = Object.entries(sizeCounts)
          .sort((a, b) => b[1] - a[1])
          .map(([size]) => size)[0] || 'N/A';

        // Get payment status counts
        const paymentStatus = filteredRecords.reduce((acc, record) => {
          if (record.isPaymentMade) acc.paid++;
          else acc.unpaid++;
          return acc;
        }, { paid: 0, unpaid: 0 });

        // Get purchase status counts
        const purchaseStatus = filteredRecords.reduce((acc, record) => {
          if (record.isProductPurchased) acc.purchased++;
          else acc.notPurchased++;
          return acc;
        }, { purchased: 0, notPurchased: 0 });

        return {
          name,
          link:filteredRecords[0].link,
          count: filteredRecords.length,
          totalAmount,
          avgPrice,
          cheapPrice,
          mostCommonSize,
          paymentStatus,
          purchaseStatus,
          records: filteredRecords
        };
      };

      const getBuyerFrequencyReport = () => {
        const buyerStats = {};

        // Calculate stats for each buyer
        records.forEach(record => {
          const buyer = record.buyerName;
          if (!buyer) return;

          if (!buyerStats[buyer]) {
            buyerStats[buyer] = {
              count: 0,
              totalAmount: 0,
              lastPurchaseDate: '',
              records: []
            };
          }

          buyerStats[buyer].count++;
          buyerStats[buyer].totalAmount += parseFloat(record.agreedPrice) || 0;

          // Keep track of the most recent purchase date
          if (!buyerStats[buyer].lastPurchaseDate ||
            record.purchaseDate > buyerStats[buyer].lastPurchaseDate) {
            buyerStats[buyer].lastPurchaseDate = record.purchaseDate;
          }

          buyerStats[buyer].records.push(record);
        });

        // Convert to array and sort by count (descending)
        return Object.entries(buyerStats)
          .map(([name, stats]) => ({ name, ...stats }))
          .sort((a, b) => b.count - a.count)
          .slice(0, 20); // Top 20 buyers
      };


      const closeModal = () => {
        setModalData(null);
        setModalType(null);
      };

      const handleBuyerHeaderClick = () => {
        requestSort('buyerName');
        showStatsModal('buyerFrequency');
      };

      return (
        <div className="container">
          <h1 className="title">Product Tracker</h1>

          <div className="view-buttons">
            <button
              className={view === 'input' ? 'active' : 'secondary'}
              onClick={() => setView('input')}
            >
              Input Mode
            </button>
            <button
              className={view === 'view' ? 'active' : 'secondary'}
              onClick={() => setView('view')}
            >
              View Records ({records.length})
            </button>
          </div>

          {view === 'input' && (
            <div className="card fade-in">
              <h2>{editingId ? 'Edit Record' : 'Add New Record'}</h2>
              <form onSubmit={handleSubmit}>
                <div className="form-grid">
                  <div className="suggestion-container">
                    <label htmlFor="buyerName">Buyer Name *</label>
                    <input
                      type="text"
                      id="buyerName"
                      name="buyerName"
                      value={formData.buyerName}
                      onChange={handleInputChange}
                      required
                      autoComplete="off"
                    />
                    {formData.buyerName && (
                      <div className="suggestion-list">
                        {getFrequencyMap('buyerName')
                          .filter(name =>
                            name.toLowerCase().startsWith(formData.buyerName.toLowerCase()) &&
                            name !== formData.buyerName
                          )
                          .slice(0, 20) // Max 20 items
                          .map((name, index) => (
                            <div
                              key={index}
                              onClick={() => {
                                setFormData({ ...formData, buyerName: name });
                                // Optional: focus next field after selection
                                document.getElementById('productName')?.focus();
                              }}
                              className="suggestion-item"
                            >
                              {name}
                            </div>
                          ))}
                      </div>
                    )}
                  </div>
                  <div className="suggestion-container">
                    <label htmlFor="productName">Product Name *</label>
                    <input
                      type="text"
                      id="productName"
                      name="productName"
                      value={formData.productName}
                      onChange={handleInputChange}
                      required
                      autoComplete="off"
                    />
                    {formData.productName && (
                      <div className="suggestion-list">
                        {getFrequencyMap('productName')
                          .filter(product =>
                            product.toLowerCase().startsWith(formData.productName.toLowerCase()) &&
                            product !== formData.productName
                          )
                          .slice(0, 20)
                          .map((product, index) => (
                            <div
                              key={index}
                              onClick={() => {
                                setFormData({ ...formData, productName: product });
                                document.getElementById('link')?.focus();
                              }}
                              className="suggestion-item"
                            >
                              {product}
                            </div>
                          ))}
                      </div>
                    )}
                  </div>
                  <div>
                    <label htmlFor="link">Link (Optional)</label>
                    <input
                      type="text"
                      id="link"
                      name="link"
                      value={formData.link}
                      onChange={handleInputChange}
                    />
                  </div>

                  <div className="suggestion-container">
                    <label htmlFor="agreedPrice">Agreed Price *</label>
                    <input
                      type="number"
                      id="agreedPrice"
                      name="agreedPrice"
                      value={formData.agreedPrice}
                      onChange={handleInputChange}
                      required
                      step="1"
                      autoComplete="off"
                    />
                    {formData.agreedPrice && (
                      <div className="suggestion-list">
                        {getFrequencyMap('agreedPrice')
                          .filter(price =>
                            price.startsWith(formData.agreedPrice) &&
                            price !== formData.agreedPrice
                          )
                          .slice(0, 20)
                          .map((price, index) => (
                            <div
                              key={index}
                              onClick={() => {
                                setFormData({ ...formData, agreedPrice: price });
                                document.getElementById('size')?.focus();
                              }}
                              className="suggestion-item"
                            >
                              {price}
                            </div>
                          ))}
                      </div>
                    )}
                  </div>

                  <div>
                    <label htmlFor="size">Size *</label>
                    <input
                      type="text"
                      id="size"
                      name="size"
                      value={formData.size}
                      onChange={handleInputChange}
                      required
                    />
                  </div>

                  <div>
                    <label htmlFor="purchaseDate">Purchase Date (Optional)</label>
                    <input
                      type="date"
                      id="purchaseDate"
                      name="purchaseDate"
                      value={formData.purchaseDate}
                      onChange={handleInputChange}
                    />
                  </div>

                  <div>
                    <label>
                      <input
                        type="checkbox"
                        name="isPaymentMade"
                        checked={formData.isPaymentMade}
                        onChange={handleInputChange}
                        role="switch"
                      />
                      Payment Made
                    </label>
                  </div>

                  <div>
                    <label>
                      <input
                        type="checkbox"
                        name="isProductPurchased"
                        checked={formData.isProductPurchased}
                        onChange={handleInputChange}
                        role="switch"
                      />
                      Product Purchased
                    </label>
                  </div>
                </div>

                <div className="form-actions">
                  {editingId && (
                    <button
                      type="button"
                      onClick={() => {
                        setEditingId(null);
                        setFormData({
                          id: Date.now(),
                          buyerName: '',
                          productName: '',
                          link: '',
                          agreedPrice: '',
                          size: '',
                          isPaymentMade: false,
                          isProductPurchased: false,
                          isProductShort: false,
                          purchaseDate: '',
                        });
                      }}
                      className="secondary"
                    >
                      Cancel
                    </button>
                  )}
                  <button
                    type="submit"
                  >
                    {editingId ? 'Update Record' : 'Save Record'}
                  </button>
                </div>
              </form>
            </div>
          )}

          {view === 'view' && (
            <div className="card fade-in">
              <div className="search-container">
                <input
                  type="text"
                  placeholder="Search by buyer or product name..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                />
                <button
                  onClick={() => setShowArchived(!showArchived)}
                  className="secondary"
                >
                  {showArchived ? '隐藏历史单' : '显示历史单'}
                </button>
              </div>

              {records.length === 0 ? (
                <div className="empty-state">
                  无记录
                </div>
              ) : (
                <div className="table-responsive">
                  <table>
                    <thead>
                      <tr>
                        <th onClick={handleBuyerHeaderClick} className="clickable-header">
                          {"买家    "}
                          <span onClick={
                            (e) => {
                              e.stopPropagation();  // This stops the event from bubbling up
                              requestSort('buyerName');
                            }}>
                            《{getSortIcon('buyerName')}》</span>
                        </th>
                        <th onClick={handleProductHeaderClick} className="clickable-header">
                          {"产品    "}
                          <span onClick={(e) => {
                            e.stopPropagation();  // This stops the event from bubbling up
                            requestSort('productName');
                          }}>《{getSortIcon('productName')}》</span>
                        </th>
                        <th onClick={() => requestSort('agreedPrice')}>
                          价格 {getSortIcon('agreedPrice')}
                        </th>
                        <th>
                          尺码
                        </th>
                        <th onClick={() => requestSort('isPaymentMade')}>
                          付款 {getSortIcon('isPaymentMade')}
                        </th>
                        <th onClick={() => requestSort('isProductShort')}>
                          缺货 {getSortIcon('isProductShort')}
                        </th>
                        <th onClick={() => requestSort('isProductPurchased')}>
                          已购 {getSortIcon('isProductPurchased')}
                        </th>
                        <th>
                          Actions
                        </th>
                        <th>
                          隐藏
                        </th>
                        <th onClick={() => requestSort('purchaseDate')}>
                          Date {getSortIcon('purchaseDate')}
                        </th>

                      </tr>
                    </thead>
                    <tbody>
                      {displayedRecords.map((record) => (
                        <tr key={record.id}>
                          <td>
                            <span
                              className="clickable-name"
                              onClick={() => showStatsModal('buyer', record.buyerName)}
                            >
                              {record.buyerName}
                            </span>
                          </td>
                          <td>
                            {record.link ? (
                              <a href={record.link} target="_blank" rel="noopener noreferrer">
                                <span
                                  className="clickable-name"
                                  onClick={(e) => {
                                    e.preventDefault();
                                    showStatsModal('product', record.productName);
                                  }}
                                >
                                  {record.productName}
                                </span>
                              </a>
                            ) : (
                              <span
                                className="clickable-name"
                                onClick={() => showStatsModal('product', record.productName)}
                              >
                                {record.productName}
                              </span>
                            )}
                          </td>
                          <td>￥{parseFloat(record.agreedPrice).toFixed(0)}</td>
                          <td>{record.size}</td>
                          <td>
                            <input
                              type="checkbox"
                              checked={record.isPaymentMade}
                              onChange={() => {
                                const updated = records.map(r =>
                                  r.id === record.id ? { ...r, isPaymentMade: !r.isPaymentMade } : r
                                );
                                setRecords(updated);
                              }}
                            />
                          </td>
                          <td>
                            <XCheckbox
                              type="checkbox"
                              checked={record.isProductShort}
                              onChange={() => {
                                const updated = records.map(r =>
                                  r.id === record.id ? { ...r, isProductShort: !r.isProductShort } : r
                                );
                                setRecords(updated);
                              }}
                            />
                          </td>
                          <td>
                            <input
                              type="checkbox"
                              checked={record.isProductPurchased}
                              onChange={() => {
                                const updated = records.map(r =>
                                  r.id === record.id ? { ...r, isProductPurchased: !r.isProductPurchased } : r
                                );
                                setRecords(updated);
                              }}
                            />
                          </td>




                          <td className="actions-cell">
                            <button onClick={() => handleEdit(record)} className="secondary">✏️</button>
                            <button onClick={() => handleDelete(record.id)} className="secondary">🗑️</button>
                          </td>
                          <td>
                            <input
                              type="checkbox"
                              checked={record.archived || false}
                              onChange={() => {
                                const updated = records.map(r =>
                                  r.id === record.id ? { ...r, archived: !r.archived } : r
                                );
                                setRecords(updated);
                              }}
                            />
                          </td>
                          <td>{record.purchaseDate || '-'}</td>

                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          )}

          {/* Statistics Modal */}
          {modalData && (
            <div className="modal-overlay" onClick={closeModal}>
              <div className="modal-content" onClick={e => e.stopPropagation()}>
                <div className="modal-header">
                  <h5>
                    {modalType === 'buyer' ? modalData.name :
                      modalType === 'product' ? modalData.name :
                        modalType === 'buyerFrequency' ? 'Top 20 Buyers ' :
                          'Top 20 Products'}
                  </h5>
                  <button className="modal-close" onClick={closeModal}>×</button>
                </div>

                {modalType === 'buyerFrequency' || modalType === 'productFrequency' ? (
                  <div>
                    <table className="stats-table">
                      <thead>
                        <tr>
                          <th>Rank</th>
                          <th>{modalType === 'buyerFrequency' ? 'Buyer Name' : 'Product Name'}</th>
                          <th>Purchase Count</th>
                          <th>Total Amount</th>
                          <th>Last Purchase</th>
                          {modalType === 'productFrequency' && <th>Link</th>}
                        </tr>
                      </thead>
                      <tbody>
                        {modalData.map((item, index) => (
                          <tr key={item.name}>
                            <td>{index + 1}</td>
                            <td>
                              <span
                                className="clickable-name"
                                onClick={() => showStatsModal(
                                  modalType === 'buyerFrequency' ? 'buyer' : 'product',
                                  item.name
                                )}
                              >
                                {item.name}
                              </span>
                            </td>
                            <td>{item.count}</td>
                            <td>￥{item.totalAmount.toFixed(0)}</td>
                            <td>{item.lastPurchaseDate || '-'}</td>
                            {modalType === 'productFrequency' && (
                              <td>
                                {item.link && (
                                  <a href={item.link} target="_blank" rel="noopener noreferrer" className="secondary">
                                    View
                                  </a>
                                )}
                              </td>
                            )}
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                ) : (
                  <>
                    <div>
                      {modalData?.link && (
                            <p>
                              Product Link:
                              <a
                                href={modalData.link}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="url-button secondary"
                              >
                                Open URL
                              </a>
                            </p>
                          )}
                      <p>Total Records: {modalData.count}</p>
                      {modalType === 'buyer' && <p>Total Amount: ￥{modalData.totalAmount.toFixed(0)}</p>}
                      {modalType === 'product' && (
                        <>
                          <p>Total Amount: ￥{modalData.totalAmount.toFixed(0)}</p>
                          <p>Average Price: ￥{modalData.avgPrice}</p>
                          <p>Lowest Price in history: ￥{modalData.cheapPrice}</p>

                        </>
                      )}
                      <p>
                        Payment Status: {modalData.paymentStatus.paid} paid / {modalData.paymentStatus.unpaid} unpaid
                      </p>
                      <p>
                        Purchase Status: {modalData.purchaseStatus.purchased} purchased / {modalData.purchaseStatus.notPurchased} not purchased
                      </p>
                    </div>

                    <h3>All Records</h3>
                    <div style={{ maxHeight: '300px', overflowY: 'auto' }}>
                      <table className="stats-table">
                        <thead>
                          <tr>
                            <th>Date</th>
                            {modalType === 'buyer' && <th>Product</th>}
                            {modalType === 'product' && <th>Buyer</th>}
                            <th>Price</th>
                            {modalType === 'product' && <th>Size</th>}
                            <th>Paid</th>
                            <th>缺货？</th>
                            <th>已购？</th>
                          </tr>
                        </thead>
                        <tbody>
                          {modalData.records.map(record => (
                            <tr key={record.id}>
                              <td>{record.purchaseDate || '-'}</td>
                              {modalType === 'buyer' && <td>{record.productName}</td>}
                              {modalType === 'product' && <td>{record.buyerName}</td>}
                              <td>￥{parseFloat(record.agreedPrice).toFixed(0)}</td>
                              {modalType === 'product' && <td>{record.size}</td>}
                              <td>{record.isPaymentMade ? '✓' : '✗'}</td>
                              <td>{record.isProductShort ? '✓' : '✗'}</td>
                              <td>{record.isProductPurchased ? '✓' : '✗'}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </>
                )}
              </div>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>

</html>
